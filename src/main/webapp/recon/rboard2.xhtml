<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" 
			xmlns:h="http://java.sun.com/jsf/html" 
				xmlns:f="http://java.sun.com/jsf/core" 
					xmlns:p="http://primefaces.org/ui">

	<h:head>
		<h:outputStylesheet library="webjars" name="primeflex/2.0.0/primeflex.min.css" />
	</h:head>

	<h:body style="margin-left:50px">

		<style type="text/css">
			button.ui-button {
			margin-right: .5rem;
				}
				
			.dialog-style-class {
			width: 50%;
			height: 70%;
			}
		</style>


		<p:growl id="messages" />

		<h3>Recon Dashboard</h3>

		
			<div class="card">				
				<p:commandButton id="taxCompute" value="Validate Reconciliation" 
						icon="pi pi-search" actionListener="#{rview.validateRecon}">
				</p:commandButton>				
			</div>	

			<h:form id="form">			
			<div class="card">
			<h3>Income transactions</h3>

				<p:dataTable var="t" value="#{rview.trans}" sortBy="#{t.partyName}" scrollable="true" scrollHeight="400">

					<p:headerRow field="partyName"   expandable="true" expanded="#{t.partyId} !=  1}">

						<p:column headerText="Party">
							<h:outputText value="#{t.partyName}" />
						</p:column>

						<p:column headerText="TDS">
							<h:outputText value="#{rview.getTDSAggr(t.partyId)}" />
						</p:column>


						<p:column headerText="26AS">
							<h:outputText value="#{rview.get26ASAggr(t.partyId)}" />
						</p:column>

						<p:column headerText="Sales Register">
							<h:outputText value="#{rview.getSRAggr(t.partyId)}" />
						</p:column>

						<p:column headerText="Related Party">
							<h:outputText value="#{rview.getRTPAggr(t.partyId)}" />
						</p:column>

					</p:headerRow>

					<p:column headerText="Party">
						<h:outputText value="#{t.partyName}" />
					</p:column>

					<p:column headerText="TDS">
						<h:outputText value="#{t.tdsDeposited}" />
					</p:column>


					<p:column headerText="26AS Income">
						<h:outputText value="#{t.source1Amount}" />
					</p:column>

					<p:column headerText="Sales Register Income">
						<h:outputText value="#{t.source2Amount}" />
					</p:column>

					<p:column headerText="Related Party Income">
						<h:outputText value="#{t.source3Amount}" />
					</p:column>

					<p:column headerText="Nature">
						<h:outputText value="#{t.nature}" />
					</p:column>


					<p:summaryRow>

						<p:column colspan="4" style="text-align:right">
							<p:outputPanel>
								<p:commandButton id="splitBtn" value="Split" icon="pi pi-search" oncomplete="PF('splitdialog').show()">

									<f:setPropertyActionListener value="#{t.partyId}" target="#{rview.selectedPartyId}" />
									<p:resetInput target=":form:split-amount-content" />

								</p:commandButton>


								<p:commandButton id="carryFWBtn" value="Carry-Forward" icon="pi pi-search" oncomplete="PF('carryfwdialog').show()">

									<f:setPropertyActionListener value="#{t.partyId}" target="#{rview.selectedPartyId}" />
									<p:resetInput target=":form:carryfw-content" />

								</p:commandButton>


								<p:splitButton value="Reconcile" action="#{rview.splitAmount(t.partyId)}" update="messages" icon="pi pi-save" filter="true" filterMatchMode="startsWith">

									<p:submenu label="Split">
										<p:menuitem value="Split by default" action="#{rview.splitAmountByDefault(t.partyId)}" update="messages" icon="pi pi-save" />
										<p:menuitem value="Split by ratio" id="splitBy" update="messages" icon="pi pi-refresh" />

									</p:submenu>

									<p:submenu label="Carry Forward">
										<p:menuitem value="Carry Forard by default" action="#{rview.carryForwardByDefault(t.partyId)}" update="messages" ajax="false" icon="pi pi-times" />

										<p:menuitem value="Carry Forard by Feedback" action="#{rview.carryForwardByFeedback(t.partyId)}" update="messages" ajax="false" icon="pi pi-times" />
									</p:submenu>

									<p:submenu label="Review">
										<p:menuitem value="Show 26AS Transcation" action="#{rview.show26ASTrans(t.partyId)}" icon="pi pi-home" />
										<p:menuitem value="Show Sales Register" action="#{rview.showSalesTrans(t.partyId)}" update="messages" ajax="false" icon="pi pi-home" />
										<p:menuitem value="Show RTP" action="#{rview.showRTP(t.partyId)}" update="messages" ajax="false" icon="pi pi-home" />
									</p:submenu>
									
									<p:divider />

									<p:menuitem value="sInternal" icon="pi pi-star" />
								</p:splitButton>

								<h:outputText value="#{reconView.getSummary(t)}" />
							</p:outputPanel>
						</p:column>


					</p:summaryRow>
				</p:dataTable>

		</div>

				<!-- Dialog Ellement. This element shows the form which can be used for the configuration of the Split -->

				<p:dialog id="splitdg" header="Split Configuration" showEffect="fade" modal="true" widgetVar="splitdialog" responsive="true" style="dialog-style-class">

					<p:growl id="dilogmsg" />

					<p:outputPanel id="split-amount-content" class="ui-fluid">

						<div class="p-field p-col-12 p-md-4">
							<h5>Split Count</h5>
							<h:panelGrid columns="1" style="margin-bottom: 10px">
								<p:spinner id="splitCountSpinner" value="#{rview.natureMatTotal}" min="0" max="10" stepFactor="1" valueChangeListener="#{rview.onNatureCountChanged}">
									<p:ajax process="@form" update="split-amount-content dilogmsg" />
								</p:spinner>
							</h:panelGrid>
						</div>



							<p:outputPanel>
								<p:dataTable id="nmat" var="n" value="#{rview.natureMat}" editable="true" style="margin-bottom:20px" editMode="cell" widgetVar="naturematrixwig" editInitEvent="dblclick"
									scrollable="true" scrollHeight="250">


									<p:ajax event="rowEdit" listener="#{rview.onNatureEdit}" update="messages" />

									<p:column headerText="Type of Income">
										<p:cellEditor>
											<f:facet name="output">
												<h:outputText value="#{n.incomeType}" />
											</f:facet>

											<f:facet name="input">
												<p:inputText id="modelInput" value="#{n.incomeType}" style="width:100%" />
											</f:facet>
										</p:cellEditor>
									</p:column>

									<p:column headerText="Nature">
										<p:cellEditor>
											<f:facet name="output">
												<h:outputText value="#{n.nature}" />
											</f:facet>
											<f:facet name="input">
												<h:selectOneMenu value="#{n.nature}" style="width:100%">
													<f:selectItems value="#{rview.natureList}" var="nature" itemLabel="#{nature}" itemValue="#{nature}" />
												</h:selectOneMenu>
											</f:facet>
										</p:cellEditor>
									</p:column>


									<p:column headerText="Amount">
										<p:cellEditor>
											<f:facet name="output">
												<h:outputText value="#{n.ratio}">
													<f:convertNumber />
												</h:outputText>
											</f:facet>
											<f:facet name="input">
												<p:inputNumber value="#{n.ratio}" style="width:100%" label="Ratio" />
											</f:facet>
										</p:cellEditor>
									</p:column>


									<p:column headerText="Action">
										<p:commandButton class="ui-button-warning rounded-button" icon="pi pi-trash" actionListener="#{rview.deleteNature(n)}" process="@this"
											update="nmat messages :form:splitCountSpinner">
										</p:commandButton>
									</p:column>
									


								</p:dataTable>
							</p:outputPanel>


					</p:outputPanel>

					<f:facet name="footer">

						<h:panelGrid columns="3" style="margin-bottom: 10px">
							<p:commandButton value="Reset Ratios" icon="pi pi-check" actionListener="#{rview.deleteAllRatio}" update="split-amount-content splitCountSpinner"
								process="split-amount-content @this" />

							<p:commandButton value="Split Amount" icon="pi pi-check" actionListener="#{rview.splitGlobalAmount}" 
								update="form" process="split-amount-content @this"
									oncomplete="PF('splitDialog').hide()" />


							<p:commandButton value="Cancel" icon="pi pi-times" onclick="PF('splitDialog').hide()" class="ui-button-secondary" />
						</h:panelGrid>

					</f:facet>

				</p:dialog>



				<p:dialog id="carryfwdg" header="Carry Forward" showEffect="fade" modal="true" widgetVar="carryfwdialog" responsive="true" style="dialog-style-class">
					<p:growl id="carryfwmsg" />

					<p:outputPanel id="carryfw-content" class="ui-fluid">

						<div class="p-field p-col-12 p-md-6">
							<h4>Source</h4>						
							<p:selectOneMenu id="sourcemenu" value="#{rview.selectedCfSource}">                    			
								<f:selectItems value="#{ref.defSources}" var="source" itemLabel="#{source}" itemValue="#{source}" />
                			</p:selectOneMenu>
						
						</div>

						<div class="p-field p-col-12 p-md-3">
							<h4>Reason</h4>
												
							<p:selectOneMenu id="reasonmenu" value="#{rview.selectedReasons}">                    			
								<f:selectItems value="#{ref.defReasons}" />
                			</p:selectOneMenu>
															
							
						</div>

										
						<div class="p-field p-col-12 p-md-3">
							<h4>Amount</h4>
							<p:inputNumber id="carryfwinput2" value="#{rview.carryfwamount}" decimalSeparator="." thousandSeparator="," />
						</div>
						
						<div class="p-field p-col-12 p-md-3">
							<h4>Reason in detail (Max 256 Characters)</h4>
							<p:inputTextarea rows="5" cols="30"  maxlength="256" autoResize="false" id="carryfwinput3"
								value="#{rview.carryfwreasondetail}" />
						</div >




						<div class="p-field p-col-12 p-md-6">
							<h:panelGrid columns="3" >
								<p:commandButton value="Carry Forward" icon="pi pi-check" 
									actionListener="#{rview.carryFw}" update="carryfw-content cfpannel" process="carryfw-content @this" 
										oncomplete="PF('carryfwdialog').hide()"
										/>
	
								<p:commandButton value="Cancel" icon="pi pi-times" onclick="PF('carryfwdialog').hide()" 
									class="ui-button-secondary" />
							</h:panelGrid>
						</div>

					</p:outputPanel>

				</p:dialog>



		<p:outputPanel id="cfpannel">
			<div class="card">
			<h3>Carry Forward transactions</h3>
			
				<p:dataTable var="t" value="#{rview.cfTrans}" sortBy="#{t.partyName}">
				
					<p:column headerText="Party">
						<h:outputText value="#{t.partyName}" />
					</p:column>

					<p:column headerText="Source">
						<h:outputText value="#{ref.getDefSource(t.prioritySource)}" />
					</p:column>

					<p:column headerText="Carryforward Income">
						<h:outputText value="#{t.priorityAmount}" />
					</p:column>

					<p:column headerText="Reason">
						<h:outputText value="#{t.reason}" />
					</p:column>

			</p:dataTable>
			</div>
		</p:outputPanel>


		</h:form>

	</h:body>
</html>

